/* fix_fft.c - Fixed-point in-place Fast Fourier Transform  */
/*
  All data are fixed-point short integers, in which -32768
  to +32768 represent -1.0 to +1.0 respectively. Integer
  arithmetic is used for speed, instead of the more natural
  floating-point.

  For the forward FFT (time -> freq), fixed scaling is
  performed to prevent arithmetic overflow, and to map a 0dB
  sine/cosine wave (i.e. amplitude = 32767) to two -6dB freq
  coefficients. The return value is always 0.

  For the inverse FFT (freq -> time), fixed scaling cannot be
  done, as two 0dB coefficients would sum to a peak amplitude
  of 64K, overflowing the 32k range of the fixed-point integers.
  Thus, the fix_fft() routine performs variable scaling, and
  returns a value which is the number of bits LEFT by which
  the output must be shifted to get the actual amplitude
  (i.e. if fix_fft() returns 3, each value of fr[] and fi[]
  must be multiplied by 8 (2**3) for proper scaling.
  Clearly, this cannot be done within fixed-point short
  integers. In practice, if the result is to be used as a
  filter, the scale_shift can usually be ignored, as the
  result will be approximately correctly normalized as is.

  Written by:  Tom Roberts  11/8/89
  Made portable:  Malcolm Slaney 12/15/94 malcolm@interval.com
  Enhanced:  Dimitrios P. Bouras  14 Jun 2006 dbouras@ieee.org
*/

//#define N_WAVE      1024    /* full length of Sinewave[] */
//#define LOG2_N_WAVE 10      /* log2(N_WAVE) */

#define N_WAVE      4096    /* full length of Sinewave[] */
#define LOG2_N_WAVE 12      /* log2(N_WAVE) */

/*
  Henceforth "short" implies 16-bit word. If this is not
  the case in your architecture, please replace "short"
  with a type definition which *is* a 16-bit word.
*/

/*
  Since we only use 3/4 of N_WAVE, we define only
  this many samples, in order to conserve data space.
*/
//short Sinewave[N_WAVE-N_WAVE/4] = {
//      0,    201,    402,    603,    804,   1005,   1206,   1406,
//   1607,   1808,   2009,   2209,   2410,   2610,   2811,   3011,
//   3211,   3411,   3611,   3811,   4011,   4210,   4409,   4608,
//   4807,   5006,   5205,   5403,   5601,   5799,   5997,   6195,
//   6392,   6589,   6786,   6982,   7179,   7375,   7571,   7766,
//   7961,   8156,   8351,   8545,   8739,   8932,   9126,   9319,
//   9511,   9703,   9895,  10087,  10278,  10469,  10659,  10849,
//  11038,  11227,  11416,  11604,  11792,  11980,  12166,  12353,
//  12539,  12724,  12909,  13094,  13278,  13462,  13645,  13827,
//  14009,  14191,  14372,  14552,  14732,  14911,  15090,  15268,
//  15446,  15623,  15799,  15975,  16150,  16325,  16499,  16672,
//  16845,  17017,  17189,  17360,  17530,  17699,  17868,  18036,
//  18204,  18371,  18537,  18702,  18867,  19031,  19194,  19357,
//  19519,  19680,  19840,  20000,  20159,  20317,  20474,  20631,
//  20787,  20942,  21096,  21249,  21402,  21554,  21705,  21855,
//  22004,  22153,  22301,  22448,  22594,  22739,  22883,  23027,
//  23169,  23311,  23452,  23592,  23731,  23869,  24006,  24143,
//  24278,  24413,  24546,  24679,  24811,  24942,  25072,  25201,
//  25329,  25456,  25582,  25707,  25831,  25954,  26077,  26198,
//  26318,  26437,  26556,  26673,  26789,  26905,  27019,  27132,
//  27244,  27355,  27466,  27575,  27683,  27790,  27896,  28001,
//  28105,  28208,  28309,  28410,  28510,  28608,  28706,  28802,
//  28897,  28992,  29085,  29177,  29268,  29358,  29446,  29534,
//  29621,  29706,  29790,  29873,  29955,  30036,  30116,  30195,
//  30272,  30349,  30424,  30498,  30571,  30643,  30713,  30783,
//  30851,  30918,  30984,  31049,  31113,  31175,  31236,  31297,
//  31356,  31413,  31470,  31525,  31580,  31633,  31684,  31735,
//  31785,  31833,  31880,  31926,  31970,  32014,  32056,  32097,
//  32137,  32176,  32213,  32249,  32284,  32318,  32350,  32382,
//  32412,  32441,  32468,  32495,  32520,  32544,  32567,  32588,
//  32609,  32628,  32646,  32662,  32678,  32692,  32705,  32717,
//  32727,  32736,  32744,  32751,  32757,  32761,  32764,  32766,
//  32767,  32766,  32764,  32761,  32757,  32751,  32744,  32736,
//  32727,  32717,  32705,  32692,  32678,  32662,  32646,  32628,
//  32609,  32588,  32567,  32544,  32520,  32495,  32468,  32441,
//  32412,  32382,  32350,  32318,  32284,  32249,  32213,  32176,
//  32137,  32097,  32056,  32014,  31970,  31926,  31880,  31833,
//  31785,  31735,  31684,  31633,  31580,  31525,  31470,  31413,
//  31356,  31297,  31236,  31175,  31113,  31049,  30984,  30918,
//  30851,  30783,  30713,  30643,  30571,  30498,  30424,  30349,
//  30272,  30195,  30116,  30036,  29955,  29873,  29790,  29706,
//  29621,  29534,  29446,  29358,  29268,  29177,  29085,  28992,
//  28897,  28802,  28706,  28608,  28510,  28410,  28309,  28208,
//  28105,  28001,  27896,  27790,  27683,  27575,  27466,  27355,
//  27244,  27132,  27019,  26905,  26789,  26673,  26556,  26437,
//  26318,  26198,  26077,  25954,  25831,  25707,  25582,  25456,
//  25329,  25201,  25072,  24942,  24811,  24679,  24546,  24413,
//  24278,  24143,  24006,  23869,  23731,  23592,  23452,  23311,
//  23169,  23027,  22883,  22739,  22594,  22448,  22301,  22153,
//  22004,  21855,  21705,  21554,  21402,  21249,  21096,  20942,
//  20787,  20631,  20474,  20317,  20159,  20000,  19840,  19680,
//  19519,  19357,  19194,  19031,  18867,  18702,  18537,  18371,
//  18204,  18036,  17868,  17699,  17530,  17360,  17189,  17017,
//  16845,  16672,  16499,  16325,  16150,  15975,  15799,  15623,
//  15446,  15268,  15090,  14911,  14732,  14552,  14372,  14191,
//  14009,  13827,  13645,  13462,  13278,  13094,  12909,  12724,
//  12539,  12353,  12166,  11980,  11792,  11604,  11416,  11227,
//  11038,  10849,  10659,  10469,  10278,  10087,   9895,   9703,
//   9511,   9319,   9126,   8932,   8739,   8545,   8351,   8156,
//   7961,   7766,   7571,   7375,   7179,   6982,   6786,   6589,
//   6392,   6195,   5997,   5799,   5601,   5403,   5205,   5006,
//   4807,   4608,   4409,   4210,   4011,   3811,   3611,   3411,
//   3211,   3011,   2811,   2610,   2410,   2209,   2009,   1808,
//   1607,   1406,   1206,   1005,    804,    603,    402,    201,
//      0,   -201,   -402,   -603,   -804,  -1005,  -1206,  -1406,
//  -1607,  -1808,  -2009,  -2209,  -2410,  -2610,  -2811,  -3011,
//  -3211,  -3411,  -3611,  -3811,  -4011,  -4210,  -4409,  -4608,
//  -4807,  -5006,  -5205,  -5403,  -5601,  -5799,  -5997,  -6195,
//  -6392,  -6589,  -6786,  -6982,  -7179,  -7375,  -7571,  -7766,
//  -7961,  -8156,  -8351,  -8545,  -8739,  -8932,  -9126,  -9319,
//  -9511,  -9703,  -9895, -10087, -10278, -10469, -10659, -10849,
// -11038, -11227, -11416, -11604, -11792, -11980, -12166, -12353,
// -12539, -12724, -12909, -13094, -13278, -13462, -13645, -13827,
// -14009, -14191, -14372, -14552, -14732, -14911, -15090, -15268,
// -15446, -15623, -15799, -15975, -16150, -16325, -16499, -16672,
// -16845, -17017, -17189, -17360, -17530, -17699, -17868, -18036,
// -18204, -18371, -18537, -18702, -18867, -19031, -19194, -19357,
// -19519, -19680, -19840, -20000, -20159, -20317, -20474, -20631,
// -20787, -20942, -21096, -21249, -21402, -21554, -21705, -21855,
// -22004, -22153, -22301, -22448, -22594, -22739, -22883, -23027,
// -23169, -23311, -23452, -23592, -23731, -23869, -24006, -24143,
// -24278, -24413, -24546, -24679, -24811, -24942, -25072, -25201,
// -25329, -25456, -25582, -25707, -25831, -25954, -26077, -26198,
// -26318, -26437, -26556, -26673, -26789, -26905, -27019, -27132,
// -27244, -27355, -27466, -27575, -27683, -27790, -27896, -28001,
// -28105, -28208, -28309, -28410, -28510, -28608, -28706, -28802,
// -28897, -28992, -29085, -29177, -29268, -29358, -29446, -29534,
// -29621, -29706, -29790, -29873, -29955, -30036, -30116, -30195,
// -30272, -30349, -30424, -30498, -30571, -30643, -30713, -30783,
// -30851, -30918, -30984, -31049, -31113, -31175, -31236, -31297,
// -31356, -31413, -31470, -31525, -31580, -31633, -31684, -31735,
// -31785, -31833, -31880, -31926, -31970, -32014, -32056, -32097,
// -32137, -32176, -32213, -32249, -32284, -32318, -32350, -32382,
// -32412, -32441, -32468, -32495, -32520, -32544, -32567, -32588,
// -32609, -32628, -32646, -32662, -32678, -32692, -32705, -32717,
// -32727, -32736, -32744, -32751, -32757, -32761, -32764, -32766,
//};

short Sinewave[N_WAVE-N_WAVE/4] = {
0,50,100,150,201,251,301,351,
402,452,502,552,603,653,703,753,
804,854,904,954,1005,1055,1105,1155,
1206,1256,1306,1356,1406,1457,1507,1557,
1607,1658,1708,1758,1808,1858,1908,1959,
2009,2059,2109,2159,2209,2260,2310,2360,
2410,2460,2510,2560,2610,2661,2711,2761,
2811,2861,2911,2961,3011,3061,3111,3161,
3211,3261,3311,3361,3411,3461,3511,3561,
3611,3661,3711,3761,3811,3861,3911,3961,
4011,4060,4110,4160,4210,4260,4310,4359,
4409,4459,4509,4559,4608,4658,4708,4758,
4807,4857,4907,4957,5006,5056,5106,5155,
5205,5254,5304,5354,5403,5453,5502,5552,
5601,5651,5700,5750,5799,5849,5898,5948,
5997,6047,6096,6145,6195,6244,6293,6343,
6392,6441,6491,6540,6589,6638,6688,6737,
6786,6835,6884,6933,6982,7032,7081,7130,
7179,7228,7277,7326,7375,7424,7473,7522,
7571,7619,7668,7717,7766,7815,7864,7912,
7961,8010,8059,8107,8156,8205,8253,8302,
8351,8399,8448,8496,8545,8593,8642,8690,
8739,8787,8836,8884,8932,8981,9029,9077,
9126,9174,9222,9270,9319,9367,9415,9463,
9511,9559,9607,9655,9703,9751,9799,9847,
9895,9943,9991,10039,10087,10135,10182,10230,
10278,10326,10373,10421,10469,10516,10564,10611,
10659,10706,10754,10801,10849,10896,10944,10991,
11038,11086,11133,11180,11227,11275,11322,11369,
11416,11463,11510,11557,11604,11651,11698,11745,
11792,11839,11886,11933,11980,12026,12073,12120,
12166,12213,12260,12306,12353,12399,12446,12492,
12539,12585,12632,12678,12724,12771,12817,12863,
12909,12956,13002,13048,13094,13140,13186,13232,
13278,13324,13370,13416,13462,13507,13553,13599,
13645,13690,13736,13782,13827,13873,13918,13964,
14009,14055,14100,14145,14191,14236,14281,14326,
14372,14417,14462,14507,14552,14597,14642,14687,
14732,14777,14822,14866,14911,14956,15001,15045,
15090,15135,15179,15224,15268,15313,15357,15401,
15446,15490,15534,15579,15623,15667,15711,15755,
15799,15843,15887,15931,15975,16019,16063,16107,
16150,16194,16238,16281,16325,16368,16412,16455,
16499,16542,16586,16629,16672,16716,16759,16802,
16845,16888,16931,16974,17017,17060,17103,17146,
17189,17232,17274,17317,17360,17402,17445,17487,
17530,17572,17615,17657,17699,17742,17784,17826,
17868,17910,17952,17994,18036,18078,18120,18162,
18204,18246,18287,18329,18371,18412,18454,18495,
18537,18578,18620,18661,18702,18744,18785,18826,
18867,18908,18949,18990,19031,19072,19113,19154,
19194,19235,19276,19316,19357,19397,19438,19478,
19519,19559,19599,19640,19680,19720,19760,19800,
19840,19880,19920,19960,20000,20040,20079,20119,
20159,20198,20238,20277,20317,20356,20396,20435,
20474,20513,20553,20592,20631,20670,20709,20748,
20787,20825,20864,20903,20942,20980,21019,21057,
21096,21134,21173,21211,21249,21288,21326,21364,
21402,21440,21478,21516,21554,21592,21629,21667,
21705,21743,21780,21818,21855,21893,21930,21967,
22004,22042,22079,22116,22153,22190,22227,22264,
22301,22338,22374,22411,22448,22484,22521,22557,
22594,22630,22666,22703,22739,22775,22811,22847,
22883,22919,22955,22991,23027,23062,23098,23134,
23169,23205,23240,23276,23311,23346,23382,23417,
23452,23487,23522,23557,23592,23627,23661,23696,
23731,23766,23800,23835,23869,23903,23938,23972,
24006,24041,24075,24109,24143,24177,24211,24244,
24278,24312,24346,24379,24413,24446,24480,24513,
24546,24580,24613,24646,24679,24712,24745,24778,
24811,24844,24877,24909,24942,24974,25007,25039,
25072,25104,25136,25169,25201,25233,25265,25297,
25329,25361,25392,25424,25456,25487,25519,25550,
25582,25613,25645,25676,25707,25738,25769,25800,
25831,25862,25893,25924,25954,25985,26016,26046,
26077,26107,26137,26168,26198,26228,26258,26288,
26318,26348,26378,26408,26437,26467,26497,26526,
26556,26585,26615,26644,26673,26702,26731,26760,
26789,26818,26847,26876,26905,26933,26962,26990,
27019,27047,27076,27104,27132,27160,27188,27216,
27244,27272,27300,27328,27355,27383,27411,27438,
27466,27493,27520,27548,27575,27602,27629,27656,
27683,27710,27736,27763,27790,27816,27843,27869,
27896,27922,27948,27975,28001,28027,28053,28079,
28105,28131,28156,28182,28208,28233,28259,28284,
28309,28335,28360,28385,28410,28435,28460,28485,
28510,28534,28559,28584,28608,28633,28657,28681,
28706,28730,28754,28778,28802,28826,28850,28874,
28897,28921,28945,28968,28992,29015,29038,29062,
29085,29108,29131,29154,29177,29200,29222,29245,
29268,29290,29313,29335,29358,29380,29402,29424,
29446,29468,29490,29512,29534,29556,29577,29599,
29621,29642,29663,29685,29706,29727,29748,29769,
29790,29811,29832,29853,29873,29894,29915,29935,
29955,29976,29996,30016,30036,30056,30076,30096,
30116,30136,30156,30175,30195,30214,30234,30253,
30272,30291,30311,30330,30349,30368,30386,30405,
30424,30442,30461,30480,30498,30516,30535,30553,
30571,30589,30607,30625,30643,30660,30678,30696,
30713,30731,30748,30766,30783,30800,30817,30834,
30851,30868,30885,30902,30918,30935,30951,30968,
30984,31001,31017,31033,31049,31065,31081,31097,
31113,31128,31144,31160,31175,31191,31206,31221,
31236,31252,31267,31282,31297,31311,31326,31341,
31356,31370,31385,31399,31413,31428,31442,31456,
31470,31484,31498,31512,31525,31539,31553,31566,
31580,31593,31606,31619,31633,31646,31659,31672,
31684,31697,31710,31723,31735,31748,31760,31772,
31785,31797,31809,31821,31833,31845,31856,31868,
31880,31891,31903,31914,31926,31937,31948,31959,
31970,31981,31992,32003,32014,32024,32035,32046,
32056,32066,32077,32087,32097,32107,32117,32127,
32137,32147,32156,32166,32176,32185,32194,32204,
32213,32222,32231,32240,32249,32258,32267,32275,
32284,32293,32301,32310,32318,32326,32334,32342,
32350,32358,32366,32374,32382,32389,32397,32404,
32412,32419,32426,32434,32441,32448,32455,32462,
32468,32475,32482,32488,32495,32501,32508,32514,
32520,32526,32532,32538,32544,32550,32556,32561,
32567,32572,32578,32583,32588,32594,32599,32604,
32609,32614,32618,32623,32628,32632,32637,32641,
32646,32650,32654,32658,32662,32666,32670,32674,
32678,32681,32685,32688,32692,32695,32699,32702,
32705,32708,32711,32714,32717,32719,32722,32725,
32727,32729,32732,32734,32736,32738,32740,32742,
32744,32746,32748,32750,32751,32753,32754,32755,
32757,32758,32759,32760,32761,32762,32763,32763,
32764,32765,32765,32766,32766,32766,32766,32766,
32767,32766,32766,32766,32766,32766,32765,32765,
32764,32763,32763,32762,32761,32760,32759,32758,
32757,32755,32754,32753,32751,32750,32748,32746,
32744,32742,32740,32738,32736,32734,32732,32729,
32727,32725,32722,32719,32717,32714,32711,32708,
32705,32702,32699,32695,32692,32688,32685,32681,
32678,32674,32670,32666,32662,32658,32654,32650,
32646,32641,32637,32632,32628,32623,32618,32614,
32609,32604,32599,32594,32588,32583,32578,32572,
32567,32561,32556,32550,32544,32538,32532,32526,
32520,32514,32508,32501,32495,32488,32482,32475,
32468,32462,32455,32448,32441,32434,32426,32419,
32412,32404,32397,32389,32382,32374,32366,32358,
32350,32342,32334,32326,32318,32310,32301,32293,
32284,32275,32267,32258,32249,32240,32231,32222,
32213,32204,32194,32185,32176,32166,32156,32147,
32137,32127,32117,32107,32097,32087,32077,32066,
32056,32046,32035,32024,32014,32003,31992,31981,
31970,31959,31948,31937,31926,31914,31903,31891,
31880,31868,31856,31845,31833,31821,31809,31797,
31785,31772,31760,31748,31735,31723,31710,31697,
31684,31672,31659,31646,31633,31619,31606,31593,
31580,31566,31553,31539,31525,31512,31498,31484,
31470,31456,31442,31428,31413,31399,31385,31370,
31356,31341,31326,31311,31297,31282,31267,31252,
31236,31221,31206,31191,31175,31160,31144,31128,
31113,31097,31081,31065,31049,31033,31017,31001,
30984,30968,30951,30935,30918,30902,30885,30868,
30851,30834,30817,30800,30783,30766,30748,30731,
30713,30696,30678,30660,30643,30625,30607,30589,
30571,30553,30535,30516,30498,30480,30461,30442,
30424,30405,30386,30368,30349,30330,30311,30291,
30272,30253,30234,30214,30195,30175,30156,30136,
30116,30096,30076,30056,30036,30016,29996,29976,
29955,29935,29915,29894,29873,29853,29832,29811,
29790,29769,29748,29727,29706,29685,29663,29642,
29621,29599,29577,29556,29534,29512,29490,29468,
29446,29424,29402,29380,29358,29335,29313,29290,
29268,29245,29222,29200,29177,29154,29131,29108,
29085,29062,29038,29015,28992,28968,28945,28921,
28897,28874,28850,28826,28802,28778,28754,28730,
28706,28681,28657,28633,28608,28584,28559,28534,
28510,28485,28460,28435,28410,28385,28360,28335,
28309,28284,28259,28233,28208,28182,28156,28131,
28105,28079,28053,28027,28001,27975,27948,27922,
27896,27869,27843,27816,27790,27763,27736,27710,
27683,27656,27629,27602,27575,27548,27520,27493,
27466,27438,27411,27383,27355,27328,27300,27272,
27244,27216,27188,27160,27132,27104,27076,27047,
27019,26990,26962,26933,26905,26876,26847,26818,
26789,26760,26731,26702,26673,26644,26615,26585,
26556,26526,26497,26467,26437,26408,26378,26348,
26318,26288,26258,26228,26198,26168,26137,26107,
26077,26046,26016,25985,25954,25924,25893,25862,
25831,25800,25769,25738,25707,25676,25645,25613,
25582,25550,25519,25487,25456,25424,25392,25361,
25329,25297,25265,25233,25201,25169,25136,25104,
25072,25039,25007,24974,24942,24909,24877,24844,
24811,24778,24745,24712,24679,24646,24613,24580,
24546,24513,24480,24446,24413,24379,24346,24312,
24278,24244,24211,24177,24143,24109,24075,24041,
24006,23972,23938,23903,23869,23835,23800,23766,
23731,23696,23661,23627,23592,23557,23522,23487,
23452,23417,23382,23346,23311,23276,23240,23205,
23169,23134,23098,23062,23027,22991,22955,22919,
22883,22847,22811,22775,22739,22703,22666,22630,
22594,22557,22521,22484,22448,22411,22374,22338,
22301,22264,22227,22190,22153,22116,22079,22042,
22004,21967,21930,21893,21855,21818,21780,21743,
21705,21667,21629,21592,21554,21516,21478,21440,
21402,21364,21326,21288,21249,21211,21173,21134,
21096,21057,21019,20980,20942,20903,20864,20825,
20787,20748,20709,20670,20631,20592,20553,20513,
20474,20435,20396,20356,20317,20277,20238,20198,
20159,20119,20079,20040,20000,19960,19920,19880,
19840,19800,19760,19720,19680,19640,19599,19559,
19519,19478,19438,19397,19357,19316,19276,19235,
19194,19154,19113,19072,19031,18990,18949,18908,
18867,18826,18785,18744,18702,18661,18620,18578,
18537,18495,18454,18412,18371,18329,18287,18246,
18204,18162,18120,18078,18036,17994,17952,17910,
17868,17826,17784,17742,17699,17657,17615,17572,
17530,17487,17445,17402,17360,17317,17274,17232,
17189,17146,17103,17060,17017,16974,16931,16888,
16845,16802,16759,16716,16672,16629,16586,16542,
16499,16455,16412,16368,16325,16281,16238,16194,
16150,16107,16063,16019,15975,15931,15887,15843,
15799,15755,15711,15667,15623,15579,15534,15490,
15446,15401,15357,15313,15268,15224,15179,15135,
15090,15045,15001,14956,14911,14866,14822,14777,
14732,14687,14642,14597,14552,14507,14462,14417,
14372,14326,14281,14236,14191,14145,14100,14055,
14009,13964,13918,13873,13827,13782,13736,13690,
13645,13599,13553,13507,13462,13416,13370,13324,
13278,13232,13186,13140,13094,13048,13002,12956,
12909,12863,12817,12771,12724,12678,12632,12585,
12539,12492,12446,12399,12353,12306,12260,12213,
12166,12120,12073,12026,11980,11933,11886,11839,
11792,11745,11698,11651,11604,11557,11510,11463,
11416,11369,11322,11275,11227,11180,11133,11086,
11038,10991,10944,10896,10849,10801,10754,10706,
10659,10611,10564,10516,10469,10421,10373,10326,
10278,10230,10182,10135,10087,10039,9991,9943,
9895,9847,9799,9751,9703,9655,9607,9559,
9511,9463,9415,9367,9319,9270,9222,9174,
9126,9077,9029,8981,8932,8884,8836,8787,
8739,8690,8642,8593,8545,8496,8448,8399,
8351,8302,8253,8205,8156,8107,8059,8010,
7961,7912,7864,7815,7766,7717,7668,7619,
7571,7522,7473,7424,7375,7326,7277,7228,
7179,7130,7081,7032,6982,6933,6884,6835,
6786,6737,6688,6638,6589,6540,6491,6441,
6392,6343,6293,6244,6195,6145,6096,6047,
5997,5948,5898,5849,5799,5750,5700,5651,
5601,5552,5502,5453,5403,5354,5304,5254,
5205,5155,5106,5056,5006,4957,4907,4857,
4807,4758,4708,4658,4608,4559,4509,4459,
4409,4359,4310,4260,4210,4160,4110,4060,
4011,3961,3911,3861,3811,3761,3711,3661,
3611,3561,3511,3461,3411,3361,3311,3261,
3211,3161,3111,3061,3011,2961,2911,2861,
2811,2761,2711,2661,2610,2560,2510,2460,
2410,2360,2310,2260,2209,2159,2109,2059,
2009,1959,1908,1858,1808,1758,1708,1658,
1607,1557,1507,1457,1406,1356,1306,1256,
1206,1155,1105,1055,1005,954,904,854,
804,753,703,653,603,552,502,452,
402,351,301,251,201,150,100,50,
0,-51,-101,-151,-202,-252,-302,-352,
-403,-453,-503,-553,-604,-654,-704,-754,
-805,-855,-905,-955,-1006,-1056,-1106,-1156,
-1207,-1257,-1307,-1357,-1407,-1458,-1508,-1558,
-1608,-1659,-1709,-1759,-1809,-1859,-1909,-1960,
-2010,-2060,-2110,-2160,-2210,-2261,-2311,-2361,
-2411,-2461,-2511,-2561,-2611,-2662,-2712,-2762,
-2812,-2862,-2912,-2962,-3012,-3062,-3112,-3162,
-3212,-3262,-3312,-3362,-3412,-3462,-3512,-3562,
-3612,-3662,-3712,-3762,-3812,-3862,-3912,-3962,
-4012,-4061,-4111,-4161,-4211,-4261,-4311,-4360,
-4410,-4460,-4510,-4560,-4609,-4659,-4709,-4759,
-4808,-4858,-4908,-4958,-5007,-5057,-5107,-5156,
-5206,-5255,-5305,-5355,-5404,-5454,-5503,-5553,
-5602,-5652,-5701,-5751,-5800,-5850,-5899,-5949,
-5998,-6048,-6097,-6146,-6196,-6245,-6294,-6344,
-6393,-6442,-6492,-6541,-6590,-6639,-6689,-6738,
-6787,-6836,-6885,-6934,-6983,-7033,-7082,-7131,
-7180,-7229,-7278,-7327,-7376,-7425,-7474,-7523,
-7572,-7620,-7669,-7718,-7767,-7816,-7865,-7913,
-7962,-8011,-8060,-8108,-8157,-8206,-8254,-8303,
-8352,-8400,-8449,-8497,-8546,-8594,-8643,-8691,
-8740,-8788,-8837,-8885,-8933,-8982,-9030,-9078,
-9127,-9175,-9223,-9271,-9320,-9368,-9416,-9464,
-9512,-9560,-9608,-9656,-9704,-9752,-9800,-9848,
-9896,-9944,-9992,-10040,-10088,-10136,-10183,-10231,
-10279,-10327,-10374,-10422,-10470,-10517,-10565,-10612,
-10660,-10707,-10755,-10802,-10850,-10897,-10945,-10992,
-11039,-11087,-11134,-11181,-11228,-11276,-11323,-11370,
-11417,-11464,-11511,-11558,-11605,-11652,-11699,-11746,
-11793,-11840,-11887,-11934,-11981,-12027,-12074,-12121,
-12167,-12214,-12261,-12307,-12354,-12400,-12447,-12493,
-12540,-12586,-12633,-12679,-12725,-12772,-12818,-12864,
-12910,-12957,-13003,-13049,-13095,-13141,-13187,-13233,
-13279,-13325,-13371,-13417,-13463,-13508,-13554,-13600,
-13646,-13691,-13737,-13783,-13828,-13874,-13919,-13965,
-14010,-14056,-14101,-14146,-14192,-14237,-14282,-14327,
-14373,-14418,-14463,-14508,-14553,-14598,-14643,-14688,
-14733,-14778,-14823,-14867,-14912,-14957,-15002,-15046,
-15091,-15136,-15180,-15225,-15269,-15314,-15358,-15402,
-15447,-15491,-15535,-15580,-15624,-15668,-15712,-15756,
-15800,-15844,-15888,-15932,-15976,-16020,-16064,-16108,
-16151,-16195,-16239,-16282,-16326,-16369,-16413,-16456,
-16500,-16543,-16587,-16630,-16673,-16717,-16760,-16803,
-16846,-16889,-16932,-16975,-17018,-17061,-17104,-17147,
-17190,-17233,-17275,-17318,-17361,-17403,-17446,-17488,
-17531,-17573,-17616,-17658,-17700,-17743,-17785,-17827,
-17869,-17911,-17953,-17995,-18037,-18079,-18121,-18163,
-18205,-18247,-18288,-18330,-18372,-18413,-18455,-18496,
-18538,-18579,-18621,-18662,-18703,-18745,-18786,-18827,
-18868,-18909,-18950,-18991,-19032,-19073,-19114,-19155,
-19195,-19236,-19277,-19317,-19358,-19398,-19439,-19479,
-19520,-19560,-19600,-19641,-19681,-19721,-19761,-19801,
-19841,-19881,-19921,-19961,-20001,-20041,-20080,-20120,
-20160,-20199,-20239,-20278,-20318,-20357,-20397,-20436,
-20475,-20514,-20554,-20593,-20632,-20671,-20710,-20749,
-20788,-20826,-20865,-20904,-20943,-20981,-21020,-21058,
-21097,-21135,-21174,-21212,-21250,-21289,-21327,-21365,
-21403,-21441,-21479,-21517,-21555,-21593,-21630,-21668,
-21706,-21744,-21781,-21819,-21856,-21894,-21931,-21968,
-22005,-22043,-22080,-22117,-22154,-22191,-22228,-22265,
-22302,-22339,-22375,-22412,-22449,-22485,-22522,-22558,
-22595,-22631,-22667,-22704,-22740,-22776,-22812,-22848,
-22884,-22920,-22956,-22992,-23028,-23063,-23099,-23135,
-23170,-23206,-23241,-23277,-23312,-23347,-23383,-23418,
-23453,-23488,-23523,-23558,-23593,-23628,-23662,-23697,
-23732,-23767,-23801,-23836,-23870,-23904,-23939,-23973,
-24007,-24042,-24076,-24110,-24144,-24178,-24212,-24245,
-24279,-24313,-24347,-24380,-24414,-24447,-24481,-24514,
-24547,-24581,-24614,-24647,-24680,-24713,-24746,-24779,
-24812,-24845,-24878,-24910,-24943,-24975,-25008,-25040,
-25073,-25105,-25137,-25170,-25202,-25234,-25266,-25298,
-25330,-25362,-25393,-25425,-25457,-25488,-25520,-25551,
-25583,-25614,-25646,-25677,-25708,-25739,-25770,-25801,
-25832,-25863,-25894,-25925,-25955,-25986,-26017,-26047,
-26078,-26108,-26138,-26169,-26199,-26229,-26259,-26289,
-26319,-26349,-26379,-26409,-26438,-26468,-26498,-26527,
-26557,-26586,-26616,-26645,-26674,-26703,-26732,-26761,
-26790,-26819,-26848,-26877,-26906,-26934,-26963,-26991,
-27020,-27048,-27077,-27105,-27133,-27161,-27189,-27217,
-27245,-27273,-27301,-27329,-27356,-27384,-27412,-27439,
-27467,-27494,-27521,-27549,-27576,-27603,-27630,-27657,
-27684,-27711,-27737,-27764,-27791,-27817,-27844,-27870,
-27897,-27923,-27949,-27976,-28002,-28028,-28054,-28080,
-28106,-28132,-28157,-28183,-28209,-28234,-28260,-28285,
-28310,-28336,-28361,-28386,-28411,-28436,-28461,-28486,
-28511,-28535,-28560,-28585,-28609,-28634,-28658,-28682,
-28707,-28731,-28755,-28779,-28803,-28827,-28851,-28875,
-28898,-28922,-28946,-28969,-28993,-29016,-29039,-29063,
-29086,-29109,-29132,-29155,-29178,-29201,-29223,-29246,
-29269,-29291,-29314,-29336,-29359,-29381,-29403,-29425,
-29447,-29469,-29491,-29513,-29535,-29557,-29578,-29600,
-29622,-29643,-29664,-29686,-29707,-29728,-29749,-29770,
-29791,-29812,-29833,-29854,-29874,-29895,-29916,-29936,
-29956,-29977,-29997,-30017,-30037,-30057,-30077,-30097,
-30117,-30137,-30157,-30176,-30196,-30215,-30235,-30254,
-30273,-30292,-30312,-30331,-30350,-30369,-30387,-30406,
-30425,-30443,-30462,-30481,-30499,-30517,-30536,-30554,
-30572,-30590,-30608,-30626,-30644,-30661,-30679,-30697,
-30714,-30732,-30749,-30767,-30784,-30801,-30818,-30835,
-30852,-30869,-30886,-30903,-30919,-30936,-30952,-30969,
-30985,-31002,-31018,-31034,-31050,-31066,-31082,-31098,
-31114,-31129,-31145,-31161,-31176,-31192,-31207,-31222,
-31237,-31253,-31268,-31283,-31298,-31312,-31327,-31342,
-31357,-31371,-31386,-31400,-31414,-31429,-31443,-31457,
-31471,-31485,-31499,-31513,-31526,-31540,-31554,-31567,
-31581,-31594,-31607,-31620,-31634,-31647,-31660,-31673,
-31685,-31698,-31711,-31724,-31736,-31749,-31761,-31773,
-31786,-31798,-31810,-31822,-31834,-31846,-31857,-31869,
-31881,-31892,-31904,-31915,-31927,-31938,-31949,-31960,
-31971,-31982,-31993,-32004,-32015,-32025,-32036,-32047,
-32057,-32067,-32078,-32088,-32098,-32108,-32118,-32128,
-32138,-32148,-32157,-32167,-32177,-32186,-32195,-32205,
-32214,-32223,-32232,-32241,-32250,-32259,-32268,-32276,
-32285,-32294,-32302,-32311,-32319,-32327,-32335,-32343,
-32351,-32359,-32367,-32375,-32383,-32390,-32398,-32405,
-32413,-32420,-32427,-32435,-32442,-32449,-32456,-32463,
-32469,-32476,-32483,-32489,-32496,-32502,-32509,-32515,
-32521,-32527,-32533,-32539,-32545,-32551,-32557,-32562,
-32568,-32573,-32579,-32584,-32589,-32595,-32600,-32605,
-32610,-32615,-32619,-32624,-32629,-32633,-32638,-32642,
-32647,-32651,-32655,-32659,-32663,-32667,-32671,-32675,
-32679,-32682,-32686,-32689,-32693,-32696,-32700,-32703,
-32706,-32709,-32712,-32715,-32718,-32720,-32723,-32726,
-32728,-32730,-32733,-32735,-32737,-32739,-32741,-32743,
-32745,-32747,-32749,-32751,-32752,-32754,-32755,-32756,
-32758,-32759,-32760,-32761,-32762,-32763,-32764,-32764,
-32765,-32766,-32766,-32767,-32767,-32767,-32767,-32767,
};

/*
  FIX_MPY() - fixed-point multiplication & scaling.
  Substitute inline assembly for hardware-specific
  optimization suited to a particluar DSP processor.
  Scaling ensures that result remains 16-bit.
*/
inline short FIX_MPY(short a, short b)
{
	/* shift right one less bit (i.e. 15-1) */
	int c = ((int)a * (int)b) >> 14;
	/* last bit shifted out = rounding-bit */
	b = c & 0x01;
	/* last shift + rounding bit */
	a = (c >> 1) + b;
	return a;
}

/*
  fix_fft() - perform forward/inverse fast Fourier transform.
  fr[n],fi[n] are real and imaginary arrays, both INPUT AND
  RESULT (in-place FFT), with 0 <= n < 2**m; set inverse to
  0 for forward transform (FFT), or 1 for iFFT.
*/
int fix_fft(short fr[], short fi[], short m, short inverse)
{
	int mr, nn, i, j, l, k, istep, n, scale, shift;
	short qr, qi, tr, ti, wr, wi;

	n = 1 << m;

	/* max FFT size = N_WAVE */
	if (n > N_WAVE)
		return -1;

	mr = 0;
	nn = n - 1;
	scale = 0;

	/* decimation in time - re-order data */
	for (m=1; m<=nn; ++m) {
		l = n;
		do {
			l >>= 1;
		} while (mr+l > nn);
		mr = (mr & (l-1)) + l;

		if (mr <= m)
			continue;
		tr = fr[m];
		fr[m] = fr[mr];
		fr[mr] = tr;
		ti = fi[m];
		fi[m] = fi[mr];
		fi[mr] = ti;
	}

	l = 1;
	k = LOG2_N_WAVE-1;
	while (l < n) {
		if (inverse) {
			/* variable scaling, depending upon data */
			shift = 0;
			for (i=0; i<n; ++i) {
				j = fr[i];
				if (j < 0)
					j = -j;
				m = fi[i];
				if (m < 0)
					m = -m;
				if (j > 16383 || m > 16383) {
					shift = 1;
					break;
				}
			}
			if (shift)
				++scale;
		} else {
			/*
			  fixed scaling, for proper normalization --
			  there will be log2(n) passes, so this results
			  in an overall factor of 1/n, distributed to
			  maximize arithmetic accuracy.
			*/
			shift = 1;
		}
		/*
		  it may not be obvious, but the shift will be
		  performed on each data point exactly once,
		  during this pass.
		*/
		istep = l << 1;
		for (m=0; m<l; ++m) {
			j = m << k;
			/* 0 <= j < N_WAVE/2 */
			wr =  Sinewave[j+N_WAVE/4];
			wi = -Sinewave[j];
			if (inverse)
				wi = -wi;
			if (shift) {
				wr >>= 1;
				wi >>= 1;
			}
			for (i=m; i<n; i+=istep) {
				j = i + l;
				tr = FIX_MPY(wr,fr[j]) - FIX_MPY(wi,fi[j]);
				ti = FIX_MPY(wr,fi[j]) + FIX_MPY(wi,fr[j]);
				qr = fr[i];
				qi = fi[i];
				if (shift) {
					qr >>= 1;
					qi >>= 1;
				}
				fr[j] = qr - tr;
				fi[j] = qi - ti;
				fr[i] = qr + tr;
				fi[i] = qi + ti;
			}
		}
		--k;
		l = istep;
	}
	return scale;
}

/*
  fix_fftr() - forward/inverse FFT on array of real numbers.
  Real FFT/iFFT using half-size complex FFT by distributing
  even/odd samples into real/imaginary arrays respectively.
  In order to save data space (i.e. to avoid two arrays, one
  for real, one for imaginary samples), we proceed in the
  following two steps: a) samples are rearranged in the real
  array so that all even samples are in places 0-(N/2-1) and
  all imaginary samples in places (N/2)-(N-1), and b) fix_fft
  is called with fr and fi pointing to index 0 and index N/2
  respectively in the original array. The above guarantees
  that fix_fft "sees" consecutive real samples as alternating
  real and imaginary samples in the complex array.
*/
int fix_fftr(short f[], int m, int inverse)
{
	int i, N = 1<<(m-1), scale = 0;
	short tt, *fr=f, *fi=&f[N];

	if (inverse)
		scale = fix_fft(fi, fr, m-1, inverse);
	for (i=1; i<N; i+=2) {
		tt = f[N+i-1];
		f[N+i-1] = f[i];
		f[i] = tt;
	}
	if (! inverse)
		scale = fix_fft(fi, fr, m-1, inverse);
	return scale;
}
